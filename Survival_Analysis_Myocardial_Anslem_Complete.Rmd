---
title: "Survival Analysis Project"
author: "FONDZEWONG WIYFENGLA ANSLEM"
date: "2024-08-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Setup and Data Preparation

```{r}
# Clear workspace and load required libraries
rm(list = ls())
library(survival)
library(ggplot2)
library(timereg)
library(gridExtra)
library(caret)
library(survminer)
```

```{r}
# Load the TRACE dataset
data(TRACE)

# Basic checks
dim(TRACE)  # Dimensions of the dataset
head(TRACE)  # First few rows of the dataset
```



Data Summary and Initial Exploration

```{r}
# Summary statistics of the dataset
summary(TRACE)

# Count the number of unique patients
nbPatients <- length(unique(rownames(TRACE)))
paste("Number of unique patients =", nbPatients)

# Count the number of missing values
paste("Total number of NA =", sum(is.na(TRACE)))
```

Data Visualization: Histograms and Pie Charts

```{r}
# Histograms for key variables
par(mfrow = c(2, 2))
hist(TRACE$age, main = "Age Distribution", xlab = "Age")
hist(TRACE$time, main = "Time Distribution", xlab = "Time")
hist(TRACE$wmi, main = "WMI Distribution", xlab = "WMI")

# Combine status values 7 and 8 into one category for better visualization
TRACE$status2 <- ifelse(TRACE$status == 7 | TRACE$status == 8, "7&8", TRACE$status)
TRACE$status2 <- factor(TRACE$status2, levels = c(0, "7&8", 9), labels = c("Alive", "Dead other causes", "Dead from MI"))
```

```{r}
# Function to create pie charts
create_pie_chart <- function(data, labels, title) {
  data <- as.data.frame(data)
  data$labels <- labels
  data$percent <- round(data$Freq / sum(data$Freq) * 100, 1)
  data$labels <- paste(data$labels, data$percent, "%")
  
  ggplot(data, aes(x = "", y = Freq, fill = labels)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    theme_void() +
    labs(title = title) +
    geom_text(aes(label = labels), position = position_stack(vjust = 0.3), size = 2.5)
}

# Generate pie charts for categorical variables
p1 <- create_pie_chart(table(TRACE$sex), c("Male", "Female"), "Sex")
p2 <- create_pie_chart(table(TRACE$status2), c("Alive", "Dead others", "Dead from MI"), "Status")
p3 <- create_pie_chart(table(TRACE$diabetes), c("Absent", "Present"), "Diabetes")
p4 <- create_pie_chart(table(TRACE$vf), c("Absent", "Present"), "Ventricular Fibrillation")
p5 <- create_pie_chart(table(TRACE$chf), c("Absent", "Present"), "Heart Pump Failure")

# Arrange the pie charts
grid.arrange(p1, p2, p3, p4, p5, ncol = 2)

```


```{r}
head(TRACE)
```





Nonparametric Estimation of Survival and Comparison of Groups

          This section involves Kaplan-Meier estimation, which is a nonparametric method used to estimate the survival function from the data. The overall survival probability is estimated, and the survival probability is compared between different groups, such as male and female patients. A log-rank test is performed to statistically compare the survival curves between these groups.
          


    Kaplan-Meier Estimation for Overall Survival

```{r}

km_fit <- survfit(Surv(time, status == 9) ~ 1, data = TRACE)

# Plotting
ggsurvplot(km_fit, 
           conf.int = TRUE, 
           title = "Overall Survival", 
           xlab = "Time (years)", 
           ylab = "Survival Probability")
```

```{r}
km_fit
```



After fitting the model, it generates a plot showing the survival probability over time, with confidence intervals to indicate the uncertainty around the estimated survival probabilities.



    Kaplan-Meier Estimation by Sex
    
    Here, the survival analysis is extended by grouping the data based on the sex of the individuals. This allows for a comparison of survival probabilities between different groups (in this case, males and females). A separate Kaplan-Meier curve is generated for each group, and these curves are plotted together to visually compare the survival experiences of the groups over time.
    
```{r}
km_fit_sex <- survfit(Surv(time, status == 9) ~ sex, data = TRACE)

# Plotting
ggsurvplot(km_fit_sex, 
           conf.int = TRUE, 
           title = "Survival by Sex", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.labs = c("Male", "Female"))

```


    Log-rank test to compare survival between groups
```{r}
surv_diff <- survdiff(Surv(time, status == 9) ~ sex, data = TRACE)

# Display the result
surv_diff

```


Kaplan-Meier Estimation by Age Group
  Here patients are divided into three age groups: < 60 years, 60-70 years, and > 70 years. This is done using the cut function, which segments continuous age data into specified intervals.
Kaplan-Meier Fit: A Kaplan-Meier survival curve is estimated for each of these age groups using the survfit function.
Plotting: The ggsurvplot function is used to visualize the survival curves for each age group, showing how survival probability changes over time across the different age categories.

```{r}
# Create age groups
TRACE$age_group <- cut(TRACE$age, breaks = c(-Inf, 60, 70, Inf), labels = c("< 60 years", "60-70 years", "> 70 years"))

# Kaplan-Meier fit by age group
km_fit_age <- survfit(Surv(time, status == 9) ~ age_group, data = TRACE)

# Plotting
ggsurvplot(km_fit_age, 
           conf.int = TRUE, 
           title = "Survival by Age Group", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.labs = levels(TRACE$age_group))

```
    Log-rank test to compare survival between Age Group
```{r}
km_fit_age <- survfit(Surv(time, status == 9) ~ age_group, data = TRACE)

# Display the result
km_fit_age

```



Kaplan-Meier Estimation by WMI Group

Grouping: Patients are categorized into three groups based on their WMI (Wall Motion Index) values: Low, Medium, and High. The groups are defined by dividing the WMI data into three equal parts (tertiles) based on quantiles.
Kaplan-Meier Fit: Kaplan-Meier survival curves are computed for each WMI group.
Plotting: The survival curves are plotted, allowing comparison of survival probabilities among patients with low, medium, and high WMI values.



```{r}
# Create WMI groups
TRACE$wmi_group <- cut(TRACE$wmi, breaks = quantile(TRACE$wmi, probs = c(0, 0.33, 0.66, 1), na.rm = TRUE), labels = c("Low", "Medium", "High"))

# Kaplan-Meier fit by WMI group
km_fit_wmi <- survfit(Surv(time, status == 9) ~ wmi_group, data = TRACE)

# Plotting
ggsurvplot(km_fit_wmi, 
           conf.int = TRUE, 
           title = "Survival by WMI Group", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.labs = levels(TRACE$wmi_group))

```

    Log-rank test to compare survival WMI Group
```{r}
km_fit_wmi <- survfit(Surv(time, status == 9) ~ wmi_group, data = TRACE)

# Display the result
km_fit_wmi
```



Kaplan-Meier Estimation by Diabetes Status

Patients are grouped based on the presence or absence of diabetes.
Kaplan-Meier Fit: A Kaplan-Meier survival analysis is performed separately for patients with and without diabetes.
Plotting: The resulting survival curves are displayed, showing differences in survival probabilities between diabetic and non-diabetic patients.
```{r}
# Kaplan-Meier fit by diabetes status
km_fit_diabetes <- survfit(Surv(time, status == 9) ~ diabetes, data = TRACE)

# Plotting
ggsurvplot(km_fit_diabetes, 
           conf.int = TRUE, 
           title = "Survival by Diabetes Status", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.labs = c("Absent", "Present"))

```
  
    Log-rank test to compare survival Diabetes Status
```{r}
km_fit_diabetes <- survfit(Surv(time, status == 9) ~ diabetes, data = TRACE)

# Display the result
km_fit_diabetes
```



Kaplan-Meier Estimation by Ventricular Fibrillation (VF) Status

Patients are divided based on whether they have ventricular fibrillation (VF) or not.
Kaplan-Meier Fit: The survival analysis is carried out for both groups: those with VF and those without.
Plotting: The survival curves for patients with and without VF are plotted, allowing visual comparison of survival probabilities between the two groups.

```{r}
# Kaplan-Meier fit by ventricular fibrillation status
km_fit_vf <- survfit(Surv(time, status == 9) ~ vf, data = TRACE)

# Plotting
ggsurvplot(km_fit_vf, 
           conf.int = TRUE, 
           title = "Survival by Ventricular Fibrillation (VF) Status", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.labs = c("Absent", "Present"))

```

    Log-rank test to compare survival Ventricular Fibrillation Status
```{r}
km_fit_vf <- survfit(Surv(time, status == 9) ~ vf, data = TRACE)

# Display the result
km_fit_vf
```



Cross Group Analysis: Diabetes Status and Ventricular Fibrillation (VF) Status
      
      This section extends the Kaplan-Meier analysis by examining the survival probabilities of patients based on both diabetes status and VF status. It creates a combined grouping of these variables, allowing for more detailed insights into how these factors interact and influence survival.

```{r}
# Kaplan-Meier fit by Diabetes and Ventricular Fibrillation (VF) Status
km_fit_diabetes_vf <- survfit(Surv(time, status == 9) ~ diabetes + vf, data = TRACE)

# Plotting
ggsurvplot(km_fit_diabetes_vf, 
           conf.int = TRUE, 
           title = "Survival by Diabetes and Ventricular Fibrillation (VF) Status", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.title = "Groups",
           legend.labs = c("Diabetes Absent & VF Absent", "Diabetes Absent & VF Present", 
                           "Diabetes Present & VF Absent", "Diabetes Present & VF Present"))

```
    Log-rank test to compare survival by Diabetes and Ventricular Fibrillation Status
```{r}
km_fit_diabetes_vf <- survfit(Surv(time, status == 9) ~ diabetes + vf, data = TRACE)

# Display the result
km_fit_diabetes_vf
```


Cross Group Analysis: Age Group and Ventricular Fibrillation (VF) Status
      
      Similar to the previous section, this analysis explores the interaction between age groups and VF status. By splitting the data into age categories and analyzing their survival alongside VF status, we gain a better understanding of how age and VF together impact survival probabilities.

```{r}
# Kaplan-Meier fit by Age Group and Ventricular Fibrillation (VF) Status
km_fit_age_vf <- survfit(Surv(time, status == 9) ~ age_group + vf, data = TRACE)

# Plotting
ggsurvplot(km_fit_age_vf, 
           conf.int = TRUE, 
           title = "Survival by Age Group and Ventricular Fibrillation (VF) Status", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.title = "Groups",
           legend.labs = c("< 60 years & VF Absent", "< 60 years & VF Present", 
                           "60-70 years & VF Absent", "60-70 years & VF Present", 
                           "> 70 years & VF Absent", "> 70 years & VF Present"))

```


    Log-rank test to compare survival by Diabetes and Ventricular Fibrillation Status
```{r}
km_fit_age_vf <- survfit(Surv(time, status == 9) ~ age_group + vf, data = TRACE)

# Display the result
km_fit_age_vf
```

Cross Group Analysis: WMI Group and Diabetes Status
      
      Here, the analysis is focused on the interaction between Wall Motion Index (WMI) groups and diabetes status. This allows for a comparison of survival probabilities across different WMI categories while also considering the presence or absence of diabetes.

```{r}
# Kaplan-Meier fit by WMI Group and Diabetes Status
km_fit_wmi_diabetes <- survfit(Surv(time, status == 9) ~ wmi_group + diabetes, data = TRACE)

# Plotting
ggsurvplot(km_fit_wmi_diabetes, 
           conf.int = TRUE, 
           title = "Survival by WMI Group and Diabetes Status", 
           xlab = "Time (years)", 
           ylab = "Survival Probability", 
           legend.title = "Groups",
           legend.labs = c("Low WMI & Diabetes Absent", "Low WMI & Diabetes Present", 
                           "Medium WMI & Diabetes Absent", "Medium WMI & Diabetes Present", 
                           "High WMI & Diabetes Absent", "High WMI & Diabetes Present"))

```


    Log-rank test to compare survival by Diabetes and Ventricular Fibrillation Status
```{r}
km_fit_wmi_diabetes <- survfit(Surv(time, status == 9) ~ wmi_group + diabetes, data = TRACE)

# Display the result
km_fit_wmi_diabetes
```




Multiplot of All Kaplan-Meier Analyses
    
    The multiplot section compiles all the Kaplan-Meier plots from the earlier sections into one combined view. This allows for a side-by-side comparison of survival probabilities across different groupings, providing a comprehensive visual summary of the survival analysis.

```{r}
# Generate individual plots
p1 <- ggsurvplot(km_fit_sex, conf.int = TRUE, title = "Survival by Sex")
p2 <- ggsurvplot(km_fit_age, conf.int = TRUE, title = "Survival by Age Group")
p3 <- ggsurvplot(km_fit_wmi, conf.int = TRUE, title = "Survival by WMI Group")
p4 <- ggsurvplot(km_fit_diabetes, conf.int = TRUE, title = "Survival by Diabetes Status")
p5 <- ggsurvplot(km_fit_vf, conf.int = TRUE, title = "Survival by Ventricular Fibrillation Status")
p6 <- ggsurvplot(km_fit_diabetes_vf, conf.int = TRUE, title = "Survival by Diabetes and VF Status")
p7 <- ggsurvplot(km_fit_age_vf, conf.int = TRUE, title = "Survival by Age Group and VF Status")
p8 <- ggsurvplot(km_fit_wmi_diabetes, conf.int = TRUE, title = "Survival by WMI and Diabetes Status")

# Arrange the plots in a multiplot layout
grid.arrange(p1$plot, p2$plot, p3$plot, p4$plot, p5$plot, p6$plot, p7$plot, p8$plot, ncol = 2)

```




























Semi-parametric Cox Regression Analysis

    In this section we focus on building Cox proportional hazards models, which are used to assess the impact of multiple covariates on survival. Two versions of the model are created: one without interaction terms and one with interaction terms. The interaction model examines whether the effect of one variable on survival depends on another variable. The results are summarized to interpret the significance and impact of each covariate.
    

    Cox Proportional Hazards Model

```{r}
cox_model <- coxph(Surv(time, status == 9) ~ age + sex + wmi + diabetes + vf + chf, data = TRACE)
summary(cox_model)
```

    Cox Model with Interaction Terms

```{r}
cox_model_interactions <- coxph(Surv(time, status == 9) ~ wmi*chf + wmi*age + wmi*sex + wmi*diabetes + wmi*vf +
                                  chf*age + chf*sex + chf*diabetes + chf*vf +
                                  age*sex + age*diabetes + age*vf +
                                  sex*diabetes + sex*vf +
                                  diabetes*vf,
                                data = TRACE)
summary(cox_model_interactions)

```





Cox Model with Ridge Penalization

    In this section, we extend the Cox model with ridge penalization, which is a regularization technique used to handle multicollinearity and prevent overfitting. This method adds a penalty to the model coefficients, helping to shrink less important variables toward zero. The summary of this model provides insight into the effects of the covariates after applying regularization.

```{r}
fit_coxph_ridge <- coxph(Surv(time, status == 9) ~ ridge(age + sex + wmi + diabetes + vf + chf), data = TRACE)
summary(fit_coxph_ridge)
```





Cross-validation of Cox Model

    Here we implement a k-fold cross-validation process to evaluate the performance of the Cox model. The dataset is split into k subsets (folds), and the model is trained on k-1 folds while being tested on the remaining fold. This process is repeated k times, and the results are averaged to assess the model’s stability and generalizability. The cross-validation helps in understanding how well the model might perform on unseen data.
```{r}
# K-Folds Cross-validation
k = 10  # Number of folds
folds <- createFolds(TRACE$status, k = k)

# Perform cross-validation
cv_results <- lapply(folds, function(x) {
  train <- TRACE[-x,]
  test <- TRACE[x,]
  fit <- coxph(Surv(time, status == 9) ~ age + sex + wmi + diabetes + vf + chf, data = train)
  return(summary(fit))
})

# Display one of the models as an example
cv_results[[1]]
```

