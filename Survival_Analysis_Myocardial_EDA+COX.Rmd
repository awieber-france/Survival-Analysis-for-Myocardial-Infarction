---
title: "Survival Analysis of Mycardial Infarction"
author: "Davat, Claire; Fondzewong Wiyfengla, Anslem; Wieber, Andrew"
date: "July 20th, 2024"
output:
  pdf_document: default
  html_document: default
---

# Activate the libraries and import the dataset

```{r}
# purge stored data
rm(list=ls())
# in package timereg
library(survival)
library(ggplot2)
library(timereg)
library(gridExtra)
library(caret)
data(TRACE)
dim(TRACE) #Check the number of lines and rows
head(TRACE) #Look at the first data
```

id:a numeric vector. Patient code.

status: a numeric vector code. Survival status. 9: dead from myocardial infarction, 0: alive, 7,8: dead from other causes.

time: a numeric vector. Survival time in years.

chf: a numeric vector code. Clinical heart pump failure, 1: present, 0: absent.

diabetes:a numeric vector code. Diabetes, 1: present, 0: absent.

vf: a numeric vector code. Ventricular fibrillation, 1: present, 0: absent.

wmi: a numeric vector. Measure of heart pumping effect based on ultrasound measurements where 2 is normal and 0 is worst.

sex: a numeric vector code. 1: female, 0: male.

age: a numeric vector code. Age of patient.


# Count the number of unique patients and missing data
```{r}
#Find the number of unique patients
nbPatients <- length(unique(rownames(TRACE)))
paste("Number of unique patients =", nbPatients)

#Find the number of NA entries
paste("Total nb of NA =", sum(is.na(TRACE)))
```

# general overview of the data
```{r}
summary(TRACE)
```
ID:
The dataset contains 6,672 unique patients

WMI (Wall Motion Index):
Ranges from 0.3 to 3.0.
The mean WMI is 1.398, indicating the average wall motion index is slightly below the mid-point of its range.
Median WMI is 1.4, suggesting a relatively normal distribution around the mean.

Status:
Median status is 9 (dead from myocardial infarction), showing that more than half of the patients died from myocardial infarction.

CHF (Congestive Heart Failure):
The mean value is 0.5229, meaning approximately 52.29% of the patients had CHF.

Age:
The age range is from 22.94 to 96.33 years, with a mean age of 67 years.
The median age is 68.23, indicating a slightly skewed distribution towards younger ages.

Sex:
This is a binary variable (1 for female, 0 for male).
The mean sex value is 0.6954, suggesting that approximately 69.54% of the patients are female.

Diabetes:
This is a binary variable (0 or 1).
The mean value is 0.1001, indicating that only about 10.01% of the patients have diabetes.

Time:
The time variable ranges from 0.000687 to 8.482000.
The mean time is 4.552470, suggesting that the average duration until the event happens is about 4.55 years.
The median time is 6.088000, indicating that more than half of the events occur after approximately 6.09 years.

VF (Ventricular Fibrillation):
The mean value is 0.07242, suggesting that about 7.24% of the patients experienced ventricular fibrillation.

Censored Data: Given the range and distribution of the 'time' variable, it is likely that some observations are censored, meaning the event of interest has not occurred for all subjects within the observed time frame.

Covariate Effects:
Age, CHF, and sex might be significant predictors of survival, given their variability and distribution in the dataset.
The presence of diabetes (though relatively infrequent) and ventricular fibrillation (VF) may also impact survival times and should be investigated.

Event Distribution: The high median status value suggests that a large proportion of subjects might have experienced the event, making this dataset suitable for survival analysis.


#Frequence of the different variable
```{r}
par(mfrow=c(2,2))
hist(TRACE$age)
hist(TRACE$time)
hist(TRACE$wmi)

```

```{r}
# Combine status values 7 and 8 into one category
TRACE$status2 <- ifelse(TRACE$status == 7 | TRACE$status == 8, "7&8", TRACE$status)
TRACE$status2 <- factor(TRACE$status2, levels = c(0, "7&8", 9), labels = c("Alive", "Dead other causes", "Dead from MI"))

# Function to create pie chart with percentages and smaller text size
create_pie_chart <- function(data, labels, title) {
  data <- as.data.frame(data)
  data$labels <- labels
  data$percent <- round(data$Freq / sum(data$Freq) * 100, 1)
  data$labels <- paste(data$labels, data$percent, "%")
  
  ggplot(data, aes(x = "", y = Freq, fill = labels)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    theme_void() +
    labs(title = title) +
    theme(legend.position = "none") +
    geom_text(aes(label = labels), position = position_stack(vjust = 0.3), size = 2.5)
}

# Data and labels
sex_counts <- table(TRACE$sex)
sex_labels <- c("Male", "Female")

status_counts <- table(TRACE$status2)
status_labels <- c("Alive", "Dead others", "Dead from MI")

diabetes_counts <- table(TRACE$diabetes)
diabetes_labels <- c("Absent", "Present")

vf_counts <- table(TRACE$vf)
vf_labels <- c("Absent", "Present")

chf_counts <- table(TRACE$chf)
chf_labels <- c("Absent", "Present")

# Create pie charts
p1 <- create_pie_chart(sex_counts, sex_labels, "Sex")
p2 <- create_pie_chart(status_counts, status_labels, "Status")
p3 <- create_pie_chart(diabetes_counts, diabetes_labels, "Diabetes")
p4 <- create_pie_chart(vf_counts, vf_labels, "Ventricular Fibrillation")
p5 <- create_pie_chart(chf_counts, chf_labels, "Heart pump failure")


```


```{r}
# Arrange the plots in a 2x2 grid
grid.arrange(p1, p2, p3, p4, p5, ncol = 2)
```


# boxplot with age
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$age~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$age~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$age~TRACE$diabetes, names = c("Absent", "Present"))
```
Age is an important factor:
- The age distribution across different status categories shows that individuals who died from myocardial infarction are generally older.
- Heart pump failure and ventricular fibrillation are more prevalent among older individuals.
- There is no significant difference in the age distribution between males and females.
- Diabetes is slightly more common in older individuals.

# boxplot with time
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$time~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$time~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$time~TRACE$diabetes, names = c("Absent", "Present"))
```
Survival time is impacted by differents factors: status, CHF, VF and diabetes
Status: Patients who are alive have the highest median survival time. Those who died from MI or other causes have significantly lower survival times.
CHF and VF: The presence of CHF or VF significantly reduces median survival time compared to those without these conditions.
Diabetes: The presence of diabetes slightly reduces median survival time, but the impact is less pronounced compared to conditions like CHF or VF.
Sex: There is a slight difference in median survival time between males and females, with females having a marginally higher median survival time.


# boxplot with wmi
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$wmi~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$wmi~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$wmi~TRACE$diabetes, names = c("Absent", "Present"))
```
worse heart pumping is associated with health conditions:
- CHF, VF and diabetes: Those with congestive heart failure or ventricular fibrillation or diabetes show a slightly lower median wmi.
- Status: The "Dead from MI" group shows a noticeably lower medianswmi compared to other status groups.
Sex: There is no significant difference between males and females regarding wmi


#Check dependency with time

```{r}
# Define the time-dependent transformation
time_dependent_transformation <- function(x, t) {
  return(x * log(t + 1))
}

# Apply the time-dependent transformation to your TRACE data
trace_transformed <- TRACE
trace_transformed$time_log <- log(trace_transformed$time + 1)

# Calculate the time effect of CHF, WMI, Diabetes, VF
chf_effect <- time_dependent_transformation(trace_transformed$chf, trace_transformed$time)
wmi_effect <- time_dependent_transformation(trace_transformed$wmi, trace_transformed$time)
vf_effect <- time_dependent_transformation(trace_transformed$vf, trace_transformed$time)
diabetes_effect <- time_dependent_transformation(trace_transformed$diabetes, trace_transformed$time)

# Create a dataframe to visualize the average effects by time interval
time_intervals <- seq(0, max(trace_transformed$time), length.out = 100)
chf_mean_effect <- sapply(time_intervals, function(t) mean(chf_effect[trace_transformed$time <= t]))
wmi_mean_effect <- sapply(time_intervals, function(t) mean(wmi_effect[trace_transformed$time <= t]))
vf_mean_effect <- sapply(time_intervals, function(t) mean(vf_effect[trace_transformed$time <= t]))
diabetes_mean_effect <- sapply(time_intervals, function(t) mean(diabetes_effect[trace_transformed$time <= t]))

```

```{r}
par(mfrow=c(2,2))

# Visualize the average time effect of CHF
plot(time_intervals, chf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'CHF- Av. Time Effect',
     main = 'CHF with log(t + 1) Transformation')

# Visualize the average time effect of WMI
plot(time_intervals, wmi_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'WMI- av. Time Effect',
     main = 'WMI with log(t + 1) Transformation')

# Visualize the average time effect of Diabetes
plot(time_intervals, diabetes_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'Diab. - av. Time Effect',
     main = 'Diabetes with log(t + 1) Transformation')

# Visualize the average time effect of vf
plot(time_intervals, vf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'VF - av. Time Effect',
     main = 'VF with log(t + 1) Transformation')

```
The transformations indicate that CHF, WMI, Diabetes, and VF all have cumulative effects on survival, with varying degrees of impact.
WMI: Shows globally the most significant impact on survival with a significant uptick after the 6th year
CHF: Shows a moderate and steadily increasing impact
Diabetes and VF: Both conditions have relatively low impact on survival. Diabetes shows a continuous increasing impact over the first 6th years. VF shows a low impact with a significant uptick after the 6th years.





# Cross-tabulation tables
```{r}
temp <- xtabs(~sex + status, data=TRACE)
rownames(temp) = c("Male","Female")
colnames(temp) = c("Alive", "Dead Other 7", "Dead Other 8", "Dead MI")
names(dimnames(temp)) <- c("SEX","DEATH STATUS (COUNTS)")
temp

cat("\n")

temp <- xtabs(~status2 + chf, data=TRACE)
rownames(temp) = c("Alive","Dead Other","Dead, MI")
colnames(temp) = c("Absent", "Present")
names(dimnames(temp)) <- c("STATUS","CLINICAL HEART FAILURE (FRACTION)")
round(temp/sum(temp), 2)

cat("\n")

temp <- xtabs(~status2 + diabetes, data=TRACE)
rownames(temp) = c("Alive","Dead Other","Dead MI")
colnames(temp) = c("Absent", "Present")
names(dimnames(temp)) <- c("STATUS","DIABETES (FRACTION)")
round(temp/sum(temp), 2)

cat("\n")

temp <- xtabs(~status2 + vf, data=TRACE)
rownames(temp) = c("Alive","Dead Other","Dead MI")
colnames(temp) = c("Absent", "Present")
names(dimnames(temp)) <- c("STATUS","VENTRICULAR FIBRILLATION (FRACTION)")
round(temp/sum(temp), 2)
```

# Cox Proportional Hazard
```{r}
cox_model_interactions <- coxph(Surv(time, status == 9) ~ wmi*chf + wmi*age + wmi*sex + wmi*diabetes + wmi*vf +
                                  chf*age + chf*sex + chf*diabetes + chf*vf +
                                  age*sex + age*diabetes + age*vf +
                                  sex*diabetes + sex*vf +
                                  diabetes*vf,
                                data = TRACE)
summary(cox_model_interactions)
```
# Schoenfeld Residuals - Null Hypothesis = Constant Covariates (proportionality of hazards)
```{r}
residual.sch <- cox.zph(cox_model_interactions)
residual.sch
```


# Cox Proportional Hazard with Ridge Penalization 
```{r}
fit.coxph <- coxph(Surv(time, status == 9) ~ ridge(age + sex + wmi + diabetes + vf + chf), data=TRACE)
summary(fit.coxph)
```
# CROSS VALIDATION + STATISTICAL ANALYSIS
## Verweij & Van Houwelingen Cross Validation
```{r}
#Make the input coxph function
coxph_chosen <- function(data){
  fit <- coxph(Surv(time, status == 9) ~ age + sex + wmi + diabetes + chf + vf, data=data)
  return(fit)
}
#Initialize the folds
k = 10 #number of folds
folds <- createFolds(TRACE$status, k = k)
#Generate matrix containing only variables used in fit
fit_all <- coxph_chosen(TRACE)
variables <- names(fit_all$assign)
X <- as.matrix(TRACE[,variables])
#Prepare variables to store results
log_likelihood_train <- list()
log_likelihood_global <- list()
# Loop through the folds 
for (i in 1:(k)){
  # Split into train and test 
  train <- TRACE[-folds[[i]],] 
  test <- TRACE[folds[[i]],]
  
  # Train the model
  fit <- coxph_chosen(train)
  betas <- as.vector(fit$coefficients)
  
  #Calculate the likelihoods using training betas on training data
  #train_loglik <- fit$loglik[2]
  X_train <- as.matrix(train[,variables])
  like_train <- (exp(X_train %*% betas) / sum(exp(X_train %*% betas))) ** (train$status == 9)
  log_likelihood_train[[i]] <- sum(log(like_train)) #instead of taking the log of the product of likelihoods
  
  #Calculate the likelihoods using training betas for all data
  like_global <- (exp(X %*% betas) / sum(exp(X %*% betas))) ** (TRACE$status == 9)
  log_likelihood_global[[i]] <- sum(log(like_global)) #instead of taking the log of the product of likelihoods
}

CVE <- -2 * sum(unlist(log_likelihood_global) - unlist(log_likelihood_train))
cat("Cross Validation Error:", CVE)
```


## Hazard Ratios
```{r}
exp(fit_all$coefficients)
```

## ANOVA
```{r}
anova(fit_all)
```

## Cox PH Conversion to Survival
```{r}
surv_coxph <- survfit(fit_all)
tail(surv_coxph$surv) #Look at survival probability
```

## Plots of CoxPH Survival & Cumulative Hazard
```{r}
plot(survfit(fit_all), main="Survival Probability",
     ylab="Probability", xlab="Years",
     col=c("turquoise", "black", "black"))

plot(survfit(fit_all, type="fleming"), fun="cumhaz", main="Cumulative Hazard",
     ylab="Hazard", xlab="Years",
     col=c("turquoise", "black", "black"))
```
## Check the proportional hazards hypothesis
```{r}
zph <- cox.zph(fit_all)
zph
plot(zph)
```

