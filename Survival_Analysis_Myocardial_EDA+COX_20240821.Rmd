---
title: "Survival Analysis of Mycardial Infarction"
author: "Davat, Claire; Fondzewong Wiyfengla, Anslem; Wieber, Andrew"
date: "July 20th, 2024"
output:
  pdf_document: default
  html_document: default
---

# Activate the libraries and import the dataset

```{r}
# purge stored data
rm(list=ls())
# in package timereg
library(survival)
library(ggplot2)
library(timereg)
library(gridExtra)
library(caret)
library(data.table)
library("survminer")
library(car)
data(TRACE)
dim(TRACE) #Check the number of lines and rows
head(TRACE) #Look at the first data
```

id:a numeric vector. Patient code.

status: a numeric vector code. Survival status. 9: dead from myocardial infarction, 0: alive, 7,8: dead from other causes.

time: a numeric vector. Survival time in years.

chf: a numeric vector code. Clinical heart pump failure, 1: present, 0: absent.

diabetes:a numeric vector code. Diabetes, 1: present, 0: absent.

vf: a numeric vector code. Ventricular fibrillation, 1: present, 0: absent.

wmi: a numeric vector. Measure of heart pumping effect based on ultrasound measurements where 2 is normal and 0 is worst.

sex: a numeric vector code. 1: female, 0: male.

age: a numeric vector code. Age of patient.


# Count the number of unique patients and missing data
```{r}
#Find the number of unique patients
nbPatients <- length(unique(rownames(TRACE)))
paste("Number of unique patients =", nbPatients)

#Find the number of NA entries
paste("Total nb of NA =", sum(is.na(TRACE)))
```

# general overview of the data
```{r}
summary(TRACE)
```
ID:
The dataset contains 6,672 unique patients

WMI (Wall Motion Index):
Ranges from 0.3 to 3.0.
The mean WMI is 1.398, indicating the average wall motion index is slightly below the mid-point of its range.
Median WMI is 1.4, suggesting a relatively normal distribution around the mean.

Status:
Median status is 9 (dead from myocardial infarction), showing that more than half of the patients died from myocardial infarction.

CHF (Congestive Heart Failure):
The mean value is 0.5229, meaning approximately 52.29% of the patients had CHF.

Age:
The age range is from 22.94 to 96.33 years, with a mean age of 67 years.
The median age is 68.23, indicating a slightly skewed distribution towards younger ages.

Sex:
This is a binary variable (1 for female, 0 for male).
The mean sex value is 0.6954, suggesting that approximately 69.54% of the patients are female.

Diabetes:
This is a binary variable (0 or 1).
The mean value is 0.1001, indicating that only about 10.01% of the patients have diabetes.

Time:
The time variable ranges from 0.000687 to 8.482000.
The mean time is 4.552470, suggesting that the average duration until the event happens is about 4.55 years.
The median time is 6.088000, indicating that more than half of the events occur after approximately 6.09 years.

VF (Ventricular Fibrillation):
The mean value is 0.07242, suggesting that about 7.24% of the patients experienced ventricular fibrillation.

Censored Data: Given the range and distribution of the 'time' variable, it is likely that some observations are censored, meaning the event of interest has not occurred for all subjects within the observed time frame.

Covariate Effects:
Age, CHF, and sex might be significant predictors of survival, given their variability and distribution in the dataset.
The presence of diabetes (though relatively infrequent) and ventricular fibrillation (VF) may also impact survival times and should be investigated.

Event Distribution: The high median status value suggests that a large proportion of subjects might have experienced the event, making this dataset suitable for survival analysis.


#Frequence of the different variable
```{r}
par(mfrow=c(2,2))
hist(TRACE$age)
hist(TRACE$time)
hist(TRACE$wmi)

```

```{r}
# Combine status values 7 and 8 into one category
TRACE$status2 <- ifelse(TRACE$status == 7 | TRACE$status == 8, "7&8", TRACE$status)
TRACE$status2 <- factor(TRACE$status2, levels = c(0, "7&8", 9), labels = c("Alive", "Dead other causes", "Dead from MI"))

# Function to create pie chart with percentages and smaller text size
create_pie_chart <- function(data, labels, title) {
  data <- as.data.frame(data)
  data$labels <- labels
  data$percent <- round(data$Freq / sum(data$Freq) * 100, 1)
  data$labels <- paste(data$labels, data$percent, "%")
  
  ggplot(data, aes(x = "", y = Freq, fill = labels)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    theme_void() +
    labs(title = title) +
    theme(legend.position = "none") +
    geom_text(aes(label = labels), position = position_stack(vjust = 0.3), size = 2.5)
}

# Data and labels
sex_counts <- table(TRACE$sex)
sex_labels <- c("Male", "Female")

status_counts <- table(TRACE$status2)
status_labels <- c("Alive", "Dead others", "Dead from MI")

diabetes_counts <- table(TRACE$diabetes)
diabetes_labels <- c("Absent", "Present")

vf_counts <- table(TRACE$vf)
vf_labels <- c("Absent", "Present")

chf_counts <- table(TRACE$chf)
chf_labels <- c("Absent", "Present")

# Create pie charts
p1 <- create_pie_chart(sex_counts, sex_labels, "Sex")
p2 <- create_pie_chart(status_counts, status_labels, "Status")
p3 <- create_pie_chart(diabetes_counts, diabetes_labels, "Diabetes")
p4 <- create_pie_chart(vf_counts, vf_labels, "Ventricular Fibrillation")
p5 <- create_pie_chart(chf_counts, chf_labels, "Heart pump failure")


```


```{r}
# Arrange the plots in a 2x2 grid
grid.arrange(p1, p2, p3, p4, p5, ncol = 2)
```


# boxplot with age
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$age~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$age~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$age~TRACE$diabetes, names = c("Absent", "Present"))
```
Age is an important factor:
- The age distribution across different status categories shows that individuals who died from myocardial infarction are generally older.
- Heart pump failure and ventricular fibrillation are more prevalent among older individuals.
- There is no significant difference in the age distribution between males and females.
- Diabetes is slightly more common in older individuals.

# boxplot with time
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$time~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$time~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$time~TRACE$diabetes, names = c("Absent", "Present"))
```
Survival time is impacted by differents factors: status, CHF, VF and diabetes
Status: Patients who are alive have the highest median survival time. Those who died from MI or other causes have significantly lower survival times.
CHF and VF: The presence of CHF or VF significantly reduces median survival time compared to those without these conditions.
Diabetes: The presence of diabetes slightly reduces median survival time, but the impact is less pronounced compared to conditions like CHF or VF.
Sex: There is a slight difference in median survival time between males and females, with females having a marginally higher median survival time.


# boxplot with wmi
```{r}
par(mfrow=c(2,3))
boxplot(TRACE$wmi~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$wmi~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$wmi~TRACE$diabetes, names = c("Absent", "Present"))
```
worse heart pumping is associated with health conditions:
- CHF, VF and diabetes: Those with congestive heart failure or ventricular fibrillation or diabetes show a slightly lower median wmi.
- Status: The "Dead from MI" group shows a noticeably lower medianswmi compared to other status groups.
Sex: There is no significant difference between males and females regarding wmi


#Check dependency with time

```{r}
# Define the time-dependent transformation
time_dependent_transformation <- function(x, t) {
  return(x * log(t + 1))
}

# Apply the time-dependent transformation to your TRACE data
trace_transformed <- TRACE
trace_transformed$time_log <- log(trace_transformed$time + 1)

# Calculate the time effect of CHF, WMI, Diabetes, VF
chf_effect <- time_dependent_transformation(trace_transformed$chf, trace_transformed$time)
wmi_effect <- time_dependent_transformation(trace_transformed$wmi, trace_transformed$time)
vf_effect <- time_dependent_transformation(trace_transformed$vf, trace_transformed$time)
diabetes_effect <- time_dependent_transformation(trace_transformed$diabetes, trace_transformed$time)

# Create a dataframe to visualize the average effects by time interval
time_intervals <- seq(0, max(trace_transformed$time), length.out = 100)
chf_mean_effect <- sapply(time_intervals, function(t) mean(chf_effect[trace_transformed$time <= t]))
wmi_mean_effect <- sapply(time_intervals, function(t) mean(wmi_effect[trace_transformed$time <= t]))
vf_mean_effect <- sapply(time_intervals, function(t) mean(vf_effect[trace_transformed$time <= t]))
diabetes_mean_effect <- sapply(time_intervals, function(t) mean(diabetes_effect[trace_transformed$time <= t]))

```

```{r}
par(mfrow=c(2,2))

# Visualize the average time effect of CHF
plot(time_intervals, chf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'CHF- Av. Time Effect',
     main = 'CHF with log(t + 1) Transformation')

# Visualize the average time effect of WMI
plot(time_intervals, wmi_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'WMI- av. Time Effect',
     main = 'WMI with log(t + 1) Transformation')

# Visualize the average time effect of Diabetes
plot(time_intervals, diabetes_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'Diab. - av. Time Effect',
     main = 'Diabetes with log(t + 1) Transformation')

# Visualize the average time effect of vf
plot(time_intervals, vf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'VF - av. Time Effect',
     main = 'VF with log(t + 1) Transformation')

```
The transformations indicate that CHF, WMI, Diabetes, and VF all have cumulative effects on survival, with varying degrees of impact.
WMI: Shows globally the most significant impact on survival with a significant uptick after the 6th year
CHF: Shows a moderate and steadily increasing impact
Diabetes and VF: Both conditions have relatively low impact on survival. Diabetes shows a continuous increasing impact over the first 6th years. VF shows a low impact with a significant uptick after the 6th years.





```{r}
#covariance
cov_matrix <- cov(TRACE[, c(3,7,8)])
print(cov_matrix)


```

```{r}
#pair plot between numeric features
pairs(~age + wmi + time,data=TRACE)
```
```{r}
cor(TRACE[,2:8])
```





## Cox Proportional Hazard
 
In this section we focus on building Cox proportional hazards models, which are used to assess the impact of multiple covariates on survival.
Different model are created to identify the best variable to take

. The interaction model examines whether the effect of one variable on survival depends on another variable. The results are summarized to interpret the significance and impact of each covariate.
    
> with all variables

In the dataset we have rigth censored data(status=1) and concurrential censored data(status =7&8). For the cox model the response variable must be binary so we could add the concurential censored data to the censored data or delete them. As we have 11 observations with this concurrential censored data, we decide to delete them from this analyse.
As we have only 11 observations with censored data (<1% observation)  we delete these observations to use cox model.



# without the concurential censored data

> data filtred on status = 0 and 9


```{r}
library(dplyr) #need for the filter function
coxTRACE <- filter(TRACE, status == 9 | status == 0)

#modification to change status=9 to status = 1
coxTRACE$status <- ifelse(coxTRACE$status==9,1,coxTRACE$status)
```

```{r}
coxTRACE
```

#quick reminder analyse and result
chf + sex + vf + age + wmi + diabetes -> sex no significative

chf + vf + age + wmi + diabetes -> violation on hypothesis on vf(++++), chf(++), wmi(++), diabetes(++) and age

chf  + age + wmi + diabetes  + sex -> sex no significant

chf  + age + wmi + diabetes ->violation on hypothesis on chf(++), wmi(++)

chf_tt + sex + vf_tt + age + wmi_tt + diabetes_tt -> violation catastrophic (gloabl : e-105) of hypothesis 

age + wmi + chf + vf + tt(wmi)  + tt(vf) + tt(diabetes),  tt = function(x, t, ...) x * log(t + 1) -> -> all variables are significant except sex, tt(chf), diabetes and tt(diabetes). As tt(diabetes) has a p-value of 0.0517 we keep it and remove the 3 others variables.

age + wmi + chf + vf + tt(wmi)  + tt(vf) + tt(diabetes), data = coxTRACE, tt = function(x, t, ...) x * log(t + 1)) -> Visually for the most of the variables the curb seems constatnt over time without clear trend except for chf

wmi+tt(wmi) +age   + vf + tt(vf) + tt(diabetes), data = coxTRACE, tt = function(x, t, ...) x * log(t + 1)) -> 








> with the feature without transformation

```{r}
cox_model_base <- coxph(Surv(time, status) ~ chf + sex + vf + age + wmi + diabetes , data = coxTRACE)
summary(cox_model_base)
vif_values <-vif(cox_model_base)
print(vif_values)
```
Except sex, all variables have a significant effect in the risk.

- chf, vf, age and diabetes have an impact on the risk of death.
- wmi shows a protective effect 


-> let's remove it
```{r}
cox_model_base2 <- coxph(Surv(time, status) ~ chf  + vf + age + wmi + diabetes , data = coxTRACE)
summary(cox_model_base2)
vif_values2 <-vif(cox_model_base2)
print(vif_values2)
# Check Schoenfeld residual without vf
cox.zph_test_base <- cox.zph(cox_model_base2)

print(cox.zph_test_base$table)

plot(cox.zph_test_base)
```

Globally, the model shows a strong violation of the hypothesis of proportionality.
All the parameters shows this violation. To notice, the strong violation of the variable vf. 
Due to the previous analysis, this result was expected and confirm the using of transformation for the variables to capture time effect.


```{r}
#Martingale residual 
coxTRACE$residual_bASE2 <- residuals(cox_model_base2, type = "martingale")

par(mfrow = c(1, 3), mar = c(4.2, 2, 2, 2))
with(coxTRACE, {

  plot(age, residual_bASE2)
  lines(lowess(age, residual_bASE2), lwd = 2)

  plot(residual_bASE2 ~ wmi)
  lines(lowess(wmi, residual_bASE2), lwd = 2)
  
  boxplot(residual_bASE2 ~ vf)
  boxplot(residual_bASE2 ~ chf)

  boxplot(residual_bASE2 ~ diabetes)

})
```
->  Age and WMI are non-linear. A transformation to linearize them could be useful, such as log, square root, power, etc.




# Check nonlinearity (Martingale residuals)
### Using reduced coxph model
```{r}
#Make a dataframe containing transforms of age and wmi

coxTRACE$age_pow_2.6 = coxTRACE$age**2.6 #Best transform to make age linear
coxTRACE$ln_wmi = log(coxTRACE$wmi) #Best transform to make WMI linear

#Fit both standard and transformed coxph models
fit <- coxph(Surv(time, status) ~ age + wmi, data=coxTRACE)
fit2 <- coxph(Surv(time, status) ~ age_pow_2.6 + ln_wmi, data=coxTRACE)

#Plot the Martingale residuals to verify that the nonlinear age and wmi variables are made linear after transformation
ggcoxfunctional(fit = fit, data=coxTRACE) #Test only continuous variables
ggcoxfunctional(fit = fit2, data=coxTRACE) #Test only continuous variables
```






Have we the same result if we remove vf of the cox model, sex(no significant) and add the transformation on age and wmi

```{r}
cox_model_base3 <- coxph(Surv(time, status) ~  chf  + age_pow_2.6 + ln_wmi + diabetes , data = coxTRACE)
summary(cox_model_base3)
vif_values3 <-vif(cox_model_base3)
print(vif_values3)
# Check Schoenfeld residual
cox.zph_test_base3 <- cox.zph(cox_model_base3)

print(cox.zph_test_base3$table)

plot(cox.zph_test_base3)
```
-> we have a violation of hypothesis due to chf and ln_wmi

-> let's try to use the strata for the time dependent features




Globally, the model continue to show a violation of the hypothesis of proportionality but age, sex and diabetes are no more rejcted the hypothesis.
-> we try to capture the effect of the time for variables: vf, chf, wmi and diabetes (we do it also with diabetes as we have seen effect of time in the EDA part)


> with interaction

```{r}
cox_model_interactions <- coxph(Surv(time, status == 9) ~ wmi*chf + wmi*age + wmi*sex + wmi*diabetes + wmi*vf +
                                  chf*age + chf*sex + chf*diabetes + chf*vf +
                                  age*sex + age*diabetes + age*vf +
                                  sex*diabetes + sex*vf +
                                  diabetes*vf,
                                data = TRACE)
summary(cox_model_interactions)
```

The interactions are significant mainly with wmi and with others variables time dependant (wmi:diabetes, wmi:vf,diabetes:vf) and with wmi:chf.
-> not necessary to check the violation of hypothesis 
-> not appropriate model

-> let's try stratification with :
strata(wmi, diabetes, vf) + strata(chf) 
strata(wmi, diabetes, vf) + strata(wmi, chf)
strata(chf) + strata(wmi) + strata(diabetes) + strata(vf)

-> for wmi, le's try with ln_wmi and strata(wmi)


> with stratification

with strata on time dependance feature including diabetes

```{r}
#with strata on time dependance 
cox_model_strata <- coxph(Surv(time, status) ~  strata(chf)   + age_pow_2.6 + ln_wmi + strata(diabetes) + strata(vf) , data = coxTRACE)
summary(cox_model_strata)
vif_values_strata <-vif(cox_model_strata)
print(vif_values_strata)
# Schoenfeld residuals
cox.zph_test_strata <- cox.zph(cox_model_strata)
print(cox.zph_test_strata$table)
plot(cox.zph_test_strata)
ggcoxdiagnostics(cox_model_strata, type = "schoenfeld")
```
-> the model is valid



```{r}
#with strata on time dependance 
cox_model_strata <- coxph(Surv(time, status) ~ age_pow_2.6 + ln_wmi + strata(diabetes,vf) + strata(chf) , data = coxTRACE)
summary(cox_model_strata)
vif_values_strata <-vif(cox_model_strata)
print(vif_values_strata)
# Schoenfeld residuals
cox.zph_test_strata <- cox.zph(cox_model_strata)
print(cox.zph_test_strata$table)
plot(cox.zph_test_strata)
ggcoxdiagnostics(cox_model_strata, type = "schoenfeld")
```
-> we can use this model



```{r}
#with strata on time dependance feature including diabetes
cox_model_strata3 <- coxph(Surv(time, status) ~  strata(chf)   + age_pow_2.6 + strata(wmi) + strata(diabetes) + strata(vf) , data = coxTRACE)
summary(cox_model_strata3)
vif_values_strata3 <-vif(cox_model_strata3)
print(vif_values_strata3)
# Schoenfeld residuals
cox.zph_test_strata3 <- cox.zph(cox_model_strata3)
print(cox.zph_test_strata3$table)
plot(cox.zph_test_strata3)
ggcoxdiagnostics(cox_model_strata3, type = "schoenfeld")
```
-> we can use this model and we could use 
strata(chf)   + age_pow_2.6 + strata(wmi,diabetes) + strata(vf)
strata(chf)   + age_pow_2.6 + strata(wmi,diabetes,vf)


```{r}
#with strata on time dependance feature including diabetes
cox_model_strata3 <- coxph(Surv(time, status) ~  strata(chf)   + age_pow_2.6 + strata(wmi) + strata(diabetes) + strata(vf) , data = coxTRACE)
summary(cox_model_strata3)
vif_values_strata3 <-vif(cox_model_strata3)
print(vif_values_strata3)
# Schoenfeld residuals
cox.zph_test_strata3 <- cox.zph(cox_model_strata3)
print(cox.zph_test_strata3$table)
plot(cox.zph_test_strata3)
ggcoxdiagnostics(cox_model_strata3, type = "schoenfeld")
```



> Continuous function to describe the time-varying


```{r}
cox_model_tvc <-coxph(Surv(time, status) ~  age_pow_2.6   + ln_wmi + chf + vf + diabetes+ tt(chf) + tt(vf) + tt(diabetes), data = coxTRACE, tt = function(x, t, ...) x * log(t + 1))
summary(cox_model_tvc)
vif_values_tvc <-vif(cox_model_tvc)
print(vif_values_tvc)

```
-> diabetes and tt(diabetes)not significant : we remove diabetes as in the previous model diabetes was significant + time dependant

```{r}
cox_model_tvc2 <-coxph(Surv(time, status) ~  age_pow_2.6   + ln_wmi + chf + vf + tt(chf) + tt(vf) + tt(diabetes) , data = coxTRACE, tt = function(x, t, ...) x * log(t + 1))
summary(cox_model_tvc2)
vif_values_tvc2 <-vif(cox_model_tvc2)
print(vif_values_tvc2)
```


-> we can't use the function cox.zph as the term tt() isn't defined so we'll try to plot manually the residuals


```{r}

schoenfeld_res2 <- residuals(cox_model_tvc2, type = "schoenfeld")
event_times <- coxTRACE$time[coxTRACE$status == 1]
# plot(schoenfeld_res2[, "tt(wmi)"] ~ event_times, 
#      main = "Schoenfeld Residuals for tt(wmi)", 
#      xlab = "Time", 
#      ylab = "Schoenfeld Residuals")
# abline(h = 0, col = "red")
# lines(lowess(event_times, schoenfeld_res2[, "tt(wmi)"]), col = "blue")
# event_times <- coxTRACE$time[coxTRACE$status == 1]

plot(schoenfeld_res2[, "tt(vf)"] ~ event_times,
     main = "Schoenfeld Residuals for tt(vf)",
     xlab = "Time",
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "tt(vf)"]), col = "blue")

plot(schoenfeld_res2[, "tt(diabetes)"] ~ event_times, 
     main = "Schoenfeld Residuals for tt(diabetes)", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "tt(diabetes)"]), col = "blue")

plot(schoenfeld_res2[, "vf"] ~ event_times, 
     main = "Schoenfeld Residuals for vf", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "vf"]), col = "blue")

plot(schoenfeld_res2[, "age_pow_2.6"] ~ event_times, 
     main = "Schoenfeld Residuals for age_pow_2.6", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "age_pow_2.6"]), col = "blue")

plot(schoenfeld_res2[, "chf"] ~ event_times, 
     main = "Schoenfeld Residuals for chf", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "chf"]), col = "blue")

plot(schoenfeld_res2[, "ln_wmi"] ~ event_times, 
     main = "Schoenfeld Residuals for ln_wmi", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res2[, "ln_wmi"]), col = "blue")
```


Visually for the most of the variables the curb seems constant over time without clear trend except for chf


-> we remove it 

```{r}
cox_model_tvc3 <-coxph(Surv(time, status) ~ age_pow_2.6   + ln_wmi   + vf + tt(vf) + tt(diabetes), data = coxTRACE, tt = function(x, t, ...) x * log(t + 1))
summary(cox_model_tvc3)
vif_values_tvc3 <-vif(cox_model_tvc3)
print(vif_values_tvc3)
```





we keep this modele however we are not completly sure of this stability as we were not able to check the proportionality

```{r}
# Extract Schoenfeld residual
schoenfeld_res3 <- residuals(cox_model_tvc3, type = "schoenfeld")

event_times <- coxTRACE$time[coxTRACE$status == 1]
plot(schoenfeld_res3[, "ln_wmi"] ~ event_times, 
     main = "Schoenfeld Residuals for ln_wmi", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res3[, "ln_wmi"]), col = "blue")
event_times <- coxTRACE$time[coxTRACE$status == 1]

plot(schoenfeld_res3[, "tt(vf)"] ~ event_times, 
     main = "Schoenfeld Residuals for tt(vf)", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res3[, "tt(vf)"]), col = "blue")

plot(schoenfeld_res3[, "tt(diabetes)"] ~ event_times, 
     main = "Schoenfeld Residuals for tt(diabetes)", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res3[, "tt(diabetes)"]), col = "blue")

plot(schoenfeld_res3[, "vf"] ~ event_times, 
     main = "Schoenfeld Residuals for vf", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res3[, "vf"]), col = "blue")

plot(schoenfeld_res3[, "age_pow_2.6"] ~ event_times, 
     main = "Schoenfeld Residuals for _pow_2.6", 
     xlab = "Time", 
     ylab = "Schoenfeld Residuals")
abline(h = 0, col = "red")
lines(lowess(event_times, schoenfeld_res3[, "age_pow_2.6"]), col = "blue")


```

-> we could try this model



> truncated

```{r}


# Survival curb
surv_object <- Surv(coxTRACE$time, coxTRACE$status)
fit <- survfit(surv_object ~ 1, data = coxTRACE)
plot(fit, xlab = "Time", ylab = "Survival prob", main = "Survival courb")

```
-> we can see an important decrease the first 1.5/2 years
-> stabilisation around 6.5/7years



```{r}
# Definition of truncation bounds
truncation_point_sup <- 6.65
truncation_point_inf <- 1.8

# Create new truncated data
coxTRACE_truncated <- within(coxTRACE, {
  status_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, status)
  time_truncated <- ifelse(time < truncation_point_inf, truncation_point_inf, ifelse(time > truncation_point_sup,truncation_point_sup , time))
  
  # Truncation of time-dependent covariates
  chf_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, chf)
  age_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, age)
  sex_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, sex)
  vf_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, vf)
  wmi_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, wmi)
  diabetes_truncated <- ifelse(time < truncation_point_inf | time > truncation_point_sup, 0, diabetes)
})

# Survival with truncated variables
surv_object_truncated <- Surv(coxTRACE_truncated$time_truncated, coxTRACE_truncated$status_truncated)
fit_truncated <- survfit(surv_object_truncated ~ 1, data = coxTRACE_truncated)

# Visualize the new survival curve
plot(fit_truncated, xlab = "Time", ylab = "Survival prob", main = "Survival curb with truncated data")

```



```{r}
cox_model_trunc <- coxph(Surv(time_truncated, status_truncated) ~ chf_truncated  + vf_truncated + age_truncated + wmi_truncated + diabetes_truncated , data = coxTRACE_truncated)
summary(cox_model_trunc)
vif_values_trunc <-vif(cox_model_trunc)
print(vif_values2)
# Check Schoenfeld residual
cox.zph_trunc <- cox.zph(cox_model_trunc)

print(cox.zph_trunc$table)

plot(cox.zph_trunc)
```



-> let's remove vf_truncated


```{r}
cox_model_trunc <- coxph(Surv(time_truncated, status_truncated) ~ chf_truncated  + age_truncated + wmi_truncated + diabetes_truncated , data = coxTRACE_truncated)
summary(cox_model_trunc)
vif_values_trunc <-vif(cox_model_trunc)
print(vif_values2)
# Check Schoenfeld residual
cox.zph_trunc <- cox.zph(cox_model_trunc)

print(cox.zph_trunc$table)

plot(cox.zph_trunc)
```

-> we can use this model





# Model comparaison

> with AIC

```{r}
# Check different models variable
model1 <- coxph(Surv(time_truncated, status_truncated) ~ chf_truncated  + age_truncated + wmi_truncated + diabetes_truncated , data = coxTRACE_truncated)
model2 <- coxph(Surv(time, status) ~  strata(chf)   + age_pow_2.6 + ln_wmi + strata(diabetes) + strata(vf),data=coxTRACE)
model3 <- coxph(Surv(time, status) ~ age_pow_2.6 + ln_wmi + strata(diabetes,vf) + strata(chf),data=coxTRACE)
model4 <- coxph(Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi) + strata(diabetes) + strata(vf),data=coxTRACE)
model5 <- coxph(Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi,diabetes) + strata(vf),data=coxTRACE)
model6 <- coxph(Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi,diabetes,vf),data=coxTRACE)
model7 <- coxph(Surv(time, status) ~ age_pow_2.6   + ln_wmi   + vf + tt(vf) + tt(diabetes), data = coxTRACE, tt = function(x, t, ...) x * log(t + 1))


# Compute AUC
aic_1 <- AIC(model1)
aic_2 <- AIC(model2)
aic_3 <- AIC(model3)
aic_4 <- AIC(model4)
aic_5 <- AIC(model5)
aic_6 <- AIC(model6)
aic_7 <- AIC(model7)


cat("\",AIC with truncated data:", aic_1, "\n")
cat("AIC with strata data - transformed data lmi:", aic_2, "\n")
cat("AIC with combined strata - transformed data lmi:", aic_3, "\n")
cat("AIC with dif strata feature :", aic_4, "\n")
cat("AIC with combined strata :", aic_5, "\n")
cat("AIC with combiend strata :", aic_6, "\n")
cat("AIC with tt():", aic_7, "\n")


```







> with cross validation

# CROSS VALIDATION + STATISTICAL ANALYSIS
## Verweij & Van Houwelingen Cross Validation
```{r}



set.seed(333891)

#Make the input coxph function
coxph_chosen <- function(data, formula, beta_init=NULL){
  if (is.null(beta_init)){
    fit <- coxph(eval(parse(text=formula)), data=data)
  } else {
    fit <- coxph(eval(parse(text=formula)), data=data, init=beta_init)
  }
  return(fit)
}



#Generate data frame ordered by survival time and with survival group column (necessary for likelihood calculation)
cross_validation <- function(df, formula, nb_folds=10){
  #Initialize the folds
  folds <- createFolds(df[,1], k = nb_folds)
  #Prepare variables to store results
  log_likelihood_train <- list()
  log_likelihood_global <- list()
  # Loop through the folds 
  for (i in 1:nb_folds){
    # Split into train and test 
    df_train <- df[-folds[[i]],] 
    #df_test <- df[folds[[i]],]
    
    # Train the model using fold
    fit <- coxph_chosen(df_train, formula)
    betas <- as.vector(fit$coefficients)
    
    # Train with all data, but using the betas derived from the fold
    fit_global <- coxph_chosen(df, formula, betas)
    
    #Save log likelihoods
    log_likelihood_train[[i]] <- fit$loglik[2] #Retrieve the final log likelihood (final betas)
    log_likelihood_global[[i]] <- fit_global$loglik[1] #Retrieve the inital log likelihood (starting betas)
  }
  CVE <- -2 * sum(unlist(log_likelihood_global) - unlist(log_likelihood_train))
  cat("Cross Validation Error: ", CVE, "\n", "Formula: ", formula, "\n\n", sep = "")
}

```







## Run Multiple CoxPH Models through the cross validation and compare
```{r}
formulas <- c("Surv(time, status) ~  strata(chf)   + age_pow_2.6 + ln_wmi + strata(diabetes) + strata(vf)",
             "Surv(time, status) ~ age_pow_2.6 + ln_wmi + strata(diabetes,vf) + strata(chf)",
             "Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi) + strata(diabetes) + strata(vf)",
             "Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi,diabetes) + strata(vf)",
             "Surv(time, status) ~ strata(chf)   + age_pow_2.6 + strata(wmi,diabetes,vf)"
           )
for (formula in formulas){
  cross_validation(coxTRACE, formula)
}
```

```{r}
formulas <- c("Surv(time_truncated, status_truncated) ~ chf_truncated  + age_truncated + wmi_truncated + diabetes_truncated , data = coxTRACE_truncated)"
           #  "Surv(time, status == 9) ~ age + sex + wmi + diabetes + chf + vf",
            # "Surv(time, status == 9) ~ ridge(age + sex + wmi + diabetes + chf + vf)",
             #"Surv(time, status == 9) ~ age + wmi + strata(sex + diabetes + chf + vf)"
           )
for (formula in formulas){
  cross_validation(coxTRACE_truncated, formula)
}
```

















> with timecox

```{r}
timecox_model <- timecox(Surv(time, status) ~ age + chf + vf + diabetes + wmi, 
                         data = coxTRACE, 
                         n.sim = 200,   # This seems to be the correct argument for simulations
                         max.time = 9 
                        )
summary(timecox_model)
```

-> Suprem test : all variable are significant
-> Kolmogorov/Cramer -> chf: time dependant


```{r}
par(mfrow=c(2,3))
plot(timecox_model)
```

```{r}
par(mfrow=c(2,3))
plot(timecox_model,score=TRUE)
```
effect of time on covariate:
- age seems stable
- chf: significant variability
-vf: time effect but which seems stable over the time
-wmi: fist 3 years, impact to time constant but small variation afetr 3 years -> possible time effect
- diabete : constant the first 3-4 years and small variation after -> -> possible time effect


Test 3 model:
const(age) + chf + vf + diabetes + wmi
const(age) + chf + vf + const(diabetes) + const(wmi)
const(age) + const(chf) + vf + const(diabetes) + const(wmi)



```{r}
timecox_model1 <- timecox(Surv(time, status) ~ const(age) + chf + vf + diabetes + wmi, 
                         data = coxTRACE, 
                         n.sim = 200,   # This seems to be the correct argument for simulations
                         max.time = 9 # This is correctly placed
                        )
timecox_model2 <- timecox(Surv(time, status) ~ const(age) + chf + vf + const(diabetes) + const(wmi), 
                         data = coxTRACE, 
                         n.sim = 200,   # This seems to be the correct argument for simulations
                         max.time = 9 # This is correctly placed
                        )
timecox_model3 <- timecox(Surv(time, status) ~ const(age) + const(chf) + vf + const(diabetes) + const(wmi), 
                         data = coxTRACE, 
                         n.sim = 200,   # This seems to be the correct argument for simulations
                         max.time = 9 # This is correctly placed
                        )


```

-> 


