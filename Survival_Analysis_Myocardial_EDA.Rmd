---
title: "Survival Analysis of Mycardial Infarction"
author: "Davat, Claire; Fondzewong Wiyfengla, Anslem; Wieber, Andrew"
date: "July 20th, 2024"
output:
  pdf_document: default
  html_document: default
---

# Activate the libraries and import the dataset

```{r}
# purge stored data
rm(list=ls())
# in package timereg
library(survival)
library(ggplot2)
library(timereg)
library(gridExtra)
data(TRACE)
dim(TRACE) #Check the number of lines and rows
head(TRACE) #Look at the first data
```
# Count the number of unique patients and missing data
```{r}
#Find the number of unique patients
nbPatients <- length(unique(rownames(TRACE)))
paste("Number of unique patients =", nbPatients)

#Find the number of NA entries
paste("Total nb of NA =", sum(is.na(TRACE)))
```
# general overview of the data
```{r}
summary(TRACE)
```


#Frequence of the different variable
```{r}
par(mfrow=c(2,2))
hist(TRACE$age)
hist(TRACE$time)
hist(TRACE$wmi)

```
```{r}
# Combine status values 7 and 8 into one category
TRACE$status2 <- ifelse(TRACE$status == 7 | TRACE$status == 8, "7&8", TRACE$status)
TRACE$status2 <- factor(TRACE$status2, levels = c(0, "7&8", 9), labels = c("Alive", "Dead other causes", "Dead from MI"))

# Function to create pie chart with percentages and smaller text size
create_pie_chart <- function(data, labels, title) {
  data <- as.data.frame(data)
  data$labels <- labels
  data$percent <- round(data$Freq / sum(data$Freq) * 100, 1)
  data$labels <- paste(data$labels, data$percent, "%")
  
  ggplot(data, aes(x = "", y = Freq, fill = labels)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    theme_void() +
    labs(title = title) +
    theme(legend.position = "none") +
    geom_text(aes(label = labels), position = position_stack(vjust = 0.3), size = 2.5)
}

# Data and labels
sex_counts <- table(TRACE$sex)
sex_labels <- c("Male", "Female")

status_counts <- table(TRACE$status2)
status_labels <- c("Alive", "Dead others", "Dead from MI")

diabetes_counts <- table(TRACE$diabetes)
diabetes_labels <- c("Absent", "Present")

vf_counts <- table(TRACE$vf)
vf_labels <- c("Absent", "Present")

chf_counts <- table(TRACE$chf)
chf_labels <- c("Absent", "Present")

# Create pie charts
p1 <- create_pie_chart(sex_counts, sex_labels, "Sex")
p2 <- create_pie_chart(status_counts, status_labels, "Status")
p3 <- create_pie_chart(diabetes_counts, diabetes_labels, "Diabetes")
p4 <- create_pie_chart(vf_counts, vf_labels, "Ventricular Fibrillation")
p5 <- create_pie_chart(chf_counts, chf_labels, "Heart pump failure")


```
```{r}
# Arrange the plots in a 2x2 grid
grid.arrange(p1, p2, p3, p4, p5, ncol = 2)
```


# boxplot with age
```{r}
par(mfrow=c(2,2))
boxplot(TRACE$age~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$age~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$age~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$age~TRACE$diabetes, names = c("Absent", "Present"))
```
Age is an important factor:
- The age distribution across different status categories shows that individuals who died from myocardial infarction are generally older.
- Heart pump failure and ventricular fibrillation are more prevalent among older individuals.
- There is no significant difference in the age distribution between males and females.
- Diabetes is slightly more common in older individuals.

# boxplot with time
```{r}
par(mfrow=c(2,2))
boxplot(TRACE$time~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$time~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$time~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$time~TRACE$diabetes, names = c("Absent", "Present"))
```
Survival time is impacted by differents factors: status, CHF, VF and diabetes
Status: Patients who are alive have the highest median survival time. Those who died from MI or other causes have significantly lower survival times.
CHF and VF: The presence of CHF or VF significantly reduces median survival time compared to those without these conditions.
Diabetes: The presence of diabetes slightly reduces median survival time, but the impact is less pronounced compared to conditions like CHF or VF.
Sex: There is a slight difference in median survival time between males and females, with females having a marginally higher median survival time.


# boxplot with wmi
```{r}
par(mfrow=c(2,2))
boxplot(TRACE$wmi~TRACE$status, names = c("Alive", "Dead others-7", "Dead others-8", "Dead from MI"))
boxplot(TRACE$wmi~TRACE$chf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$vf, names = c("Absent", "Present"))
boxplot(TRACE$wmi~TRACE$sex, names = c("Male", "Female"))
boxplot(TRACE$wmi~TRACE$diabetes, names = c("Absent", "Present"))
```
worse heart pumping is associated with health conditions:
- CHF, VF and diabetes: Those with congestive heart failure or ventricular fibrillation or diabetes show a slightly lower median wmi.
- Status: The "Dead from MI" group shows a noticeably lower medianswmi compared to other status groups.
Sex: There is no significant difference between males and females regarding wmi


#Check dependency with time

```{r}
# Define the time-dependent transformation
time_dependent_transformation <- function(x, t) {
  return(x * log(t + 1))
}

# Apply the time-dependent transformation to your TRACE data
trace_transformed <- TRACE
trace_transformed$time_log <- log(trace_transformed$time + 1)

# Calculate the time effect of CHF, WMI, Diabetes, VF
chf_effect <- time_dependent_transformation(trace_transformed$chf, trace_transformed$time)
wmi_effect <- time_dependent_transformation(trace_transformed$wmi, trace_transformed$time)
vf_effect <- time_dependent_transformation(trace_transformed$vf, trace_transformed$time)
diabetes_effect <- time_dependent_transformation(trace_transformed$diabetes, trace_transformed$time)

# Create a dataframe to visualize the average effects by time interval
time_intervals <- seq(0, max(trace_transformed$time), length.out = 100)
chf_mean_effect <- sapply(time_intervals, function(t) mean(chf_effect[trace_transformed$time <= t]))
wmi_mean_effect <- sapply(time_intervals, function(t) mean(wmi_effect[trace_transformed$time <= t]))
vf_mean_effect <- sapply(time_intervals, function(t) mean(vf_effect[trace_transformed$time <= t]))
diabetes_mean_effect <- sapply(time_intervals, function(t) mean(diabetes_effect[trace_transformed$time <= t]))

```

```{r}
par(mfrow=c(2,2))

# Visualize the average time effect of CHF
plot(time_intervals, chf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'CHF- Av. Time Effect',
     main = 'CHF with log(t + 1) Transformation')

# Visualize the average time effect of WMI
plot(time_intervals, wmi_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'WMI- av. Time Effect',
     main = 'WMI with log(t + 1) Transformation')

# Visualize the average time effect of Diabetes
plot(time_intervals, diabetes_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'Diab. - av. Time Effect',
     main = 'Diabetes with log(t + 1) Transformation')

# Visualize the average time effect of vf
plot(time_intervals, vf_mean_effect, type = 'l', col = 'red', lwd = 2,
     xlab = 'Time (years)', ylab = 'VF - av. Time Effect',
     main = 'VF with log(t + 1) Transformation')

```
The transformations indicate that CHF, WMI, Diabetes, and VF all have cumulative effects on survival, with varying degrees of impact.
WMI: Shows globally the most significant impact on survival with a significant uptick after the 6th year
CHF: Shows a moderate and steadily increasing impact
Diabetes and VF: Both conditions have relatively low impact on survival. Diabetes shows a continuous increasing impact over the first 6th years. VF shows a low impact with a significant uptick after the 6th years.































